/**
 * @fileoverview nx-integration module for the src component
 *
 * This file is part of the Dulce de Saigon F&B Data Platform.
 * Contains implementation for TypeScript functionality.
 *
 * @author Dulce de Saigon Engineering
 * @copyright Copyright (c) 2025 Dulce de Saigon
 * @license MIT
 */

import { signal } from '@angular/core';
import type { Signal } from '../index';
import { createSignal } from './index';

// Define a common interface for Redux-like stores
interface ReduxLikeStore {
  getState: () => any;
  subscribe: (listener: () => void) => () => void;
}

/**
 * Creates a signal from a Redux-like store and selector
 * @param store Redux-like store with getState() and subscribe() methods
 * @param selector Function to select portion of state
 * @returns Signal containing the selected state
 */
export function signalFromStore<T>(
  store: ReduxLikeStore,
  selector: (state: any) => T
): Signal<T> {
  // Initial value from store
  const initialValue = selector(store.getState());
  
  // Create signal with selected state
  const signalInstance = createSignal<T>(initialValue);

  // Subscribe to store changes
  const unsubscribeStore = store.subscribe(() => {
    const newValue = selector(store.getState());
    if (newValue !== undefined) {
      signalInstance.set(newValue);
    }
  });

  // Return signal instance with cleanup
  return signalInstance;
}

/**
 * Creates a signal from a selector function over a store's state.
 * Allows mapping to a different type.
 */
export function signalFromSelector<S, T = S>(
  store: ReduxLikeStore,
  selector: (state: any) => S,
  mapper?: (selected: S) => T
): Signal<T> {
  const selected = selector(store.getState());
  const initialValue = mapper ? mapper(selected) : selected as unknown as T;
  
  const signalInstance = createSignal<T>(initialValue);

  const unsubscribeStore = store.subscribe(() => {
    const newSelected = selector(store.getState());
    const newValue = mapper ? mapper(newSelected) : newSelected as unknown as T;
    signalInstance.set(newValue);
  });

  return signalInstance;
}

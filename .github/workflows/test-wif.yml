name: Test WIF Authentication

on:
  workflow_dispatch:
    inputs:
      test_deployment:
        description: 'Test a deployment after auth'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  test-auth:
    name: Test WIF Authentication
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Verify authentication
        run: |
          echo "✅ Successfully authenticated to Google Cloud!"
          echo "Project: $(gcloud config get-value project)"
          echo "Account: $(gcloud config get-value account)"
          echo ""
          echo "Available service accounts:"
          gcloud iam service-accounts list

      - name: Test Secret Manager access
        run: |
          echo "🔐 Testing Secret Manager access..."
          # List secrets (not values)
          gcloud secrets list || echo "No secrets found or no access"

      - name: Test Artifact Registry access
        run: |
          echo "📦 Testing Artifact Registry access..."
          gcloud artifacts repositories list --location=asia-southeast1 || echo "No repositories found"

      - name: Test Cloud Run access
        run: |
          echo "🚀 Testing Cloud Run access..."
          gcloud run services list --region=asia-southeast1 || echo "No services found"

      - name: Test deployment (optional)
        if: ${{ github.event.inputs.test_deployment == 'true' }}
        run: |
          echo "🧪 Testing a simple Cloud Run deployment..."
          
          # Create a simple test service
          cat > test-service.yaml << EOF
          apiVersion: serving.knative.dev/v1
          kind: Service
          metadata:
            name: wif-test-service
          spec:
            template:
              spec:
                containers:
                - image: gcr.io/cloudrun/hello
                  resources:
                    limits:
                      cpu: "0.5"
                      memory: "256Mi"
          EOF
          
          gcloud run services replace test-service.yaml --region=asia-southeast1
          
          # Clean up
          sleep 10
          gcloud run services delete wif-test-service --region=asia-southeast1 --quiet
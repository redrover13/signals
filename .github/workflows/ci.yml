name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: asia-southeast1

jobs:
  build-test-lint:
    runs-on: ubuntu-latest
    env:
      STORE_PATH: ""
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create .env.local for CI
        run: |
          cat > .env.local << EOL
          # API Environment Variables
          API_PORT=3333
          API_HOST=localhost
          API_PREFIX=/api
          API_CORS_ORIGIN=*

          # Agents Environment Variables
          AGENTS_PORT=3334
          AGENTS_HOST=localhost
          AGENTS_PREFIX=/agents
          AGENTS_CORS_ORIGIN=*

          # Web Environment Variables
          NEXT_PUBLIC_API_BASE=http://localhost:3333/api

          # Agent Frontend Environment Variables
          VITE_GEMINI_API_KEY=dummy-key
          VITE_GCP_PROJECT_ID=dummy-project
          VITE_FIREBASE_API_KEY=dummy-firebase-key
          VITE_FIREBASE_AUTH_DOMAIN=dummy-auth-domain
          VITE_FIREBASE_PROJECT_ID=dummy-project
          VITE_FIREBASE_STORAGE_BUCKET=dummy-storage
          VITE_FIREBASE_MESSAGING_SENDER_ID=dummy-sender
          VITE_FIREBASE_APP_ID=dummy-app-id
          EOL

      - name: Check environment configuration
        run: pnpm env:check

      - name: Fix CodeQL and code standard issues
        run: pnpm codeql:fix

      - name: Run Lint
        run: pnpm exec nx affected --target=lint --parallel=3

      - name: Run Tests
        run: pnpm exec nx affected --target=test --parallel=3 --ci --code-coverage

      - name: Run Type Check
        run: pnpm exec nx affected --target=type-check --parallel=3

      - name: Run Static Analysis (SAST) on AI-Generated Code
        run: |
          echo "Running SAST on AI-generated code sections..."
          # For demonstration, we'll just list files with AI-GENERATED tag
          grep -r "// AI-GENERATED" . || true

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run dependency-cruiser
        run: pnpm exec nx dep-graph --file=dep-graph.json

      - name: Upload dependency graph artifact
        uses: actions/upload-artifact@v4
        with:
          name: dep-graph
          path: dep-graph.json

  terraform-plan:
    runs-on: ubuntu-latest
    env:
      STORE_PATH: ""
    needs: build-test-lint
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2.1.2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.0.0
        with:
          terraform_version: 1.x

      - name: Terraform Init
        run: |
          cd infra/terraform/bigquery && terraform init
          cd ../functions && terraform init
          cd ../vertex-agents && terraform init
          cd ../looker && terraform init

      - name: Terraform Plan
        run: |
          cd infra/terraform/bigquery && terraform plan -out=tfplan_bigquery
          cd ../functions && terraform plan -out=tfplan_functions
          cd ../vertex-agents && terraform plan -out=tfplan_vertex_agents
          cd ../looker && terraform plan -out=tfplan_looker

      - name: Upload Terraform Plan Artifacts
        uses: actions/upload-artifact@v4.3.0
        with:
          name: terraform-plans
          path: |
            infra/terraform/bigquery/tfplan_bigquery
            infra/terraform/functions/tfplan_functions
            infra/terraform/vertex-agents/tfplan_vertex_agents
            infra/terraform/looker/tfplan_looker

  terraform-apply:
    runs-on: ubuntu-latest
    env:
      STORE_PATH: ""
    needs: terraform-plan
    environment: production
    if: github.ref == 'refs/heads/main' # Only apply to main branch
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2.1.2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.0.0
        with:
          terraform_version: 1.x

      - name: Download Terraform Plan Artifacts
        uses: actions/download-artifact@v4.0.0
        with:
          name: terraform-plans
          path: .

      - name: Terraform Apply
        run: |
          cd infra/terraform/bigquery && terraform apply tfplan_bigquery
          cd ../functions && terraform apply tfplan_functions
          cd ../vertex-agents && terraform apply tfplan_vertex_agents
          cd ../looker && terraform apply tfplan_looker

  deploy-cloud-functions:
    runs-on: ubuntu-latest
    env:
      STORE_PATH: ""
    needs: terraform-apply
    environment: production
    if: github.ref == 'refs/heads/main' # Only deploy to main branch
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10.0.0

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2.1.2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy Social API Function
        uses: google-github-actions/deploy-cloudfunctions@v2.1.2
        with:
          name: social-api
          runtime: nodejs20
          entry_point: main
          source_dir: apps/cloud-functions/social-api
          project_id: ${{ env.GCP_PROJECT_ID }}
          region: ${{ env.GCP_REGION }}

      - name: Deploy CRM API Function
        uses: google-github-actions/deploy-cloudfunctions@v2.1.2
        with:
          name: crm-api
          runtime: nodejs20
          entry_point: main
          source_dir: apps/cloud-functions/crm-api
          project_id: ${{ env.GCP_PROJECT_ID }}
          region: ${{ env.GCP_REGION }}

      - name: Deploy CMS API Function
        uses: google-github-actions/deploy-cloudfunctions@v2.1.2
        with:
          name: cms-api
          runtime: nodejs20
          entry_point: main
          source_dir: apps/cloud-functions/cms-api
          project_id: ${{ env.GCP_PROJECT_ID }}
          region: ${{ env.GCP_REGION }}

      - name: Deploy Reviews API Function
        uses: google-github-actions/deploy-cloudfunctions@v2.1.2
        with:
          name: reviews-api
          runtime: nodejs20
          entry_point: main
          source_dir: apps/cloud-functions/reviews-api
          project_id: ${{ env.GCP_PROJECT_ID }}
          region: ${{ env.GCP_REGION }}

  deploy-frontend:
    runs-on: ubuntu-latest
    env:
      STORE_PATH: ""
    needs: deploy-cloud-functions
    environment: production
    if: github.ref == 'refs/heads/main' # Only deploy to main branch
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10.0.0

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Frontend
        run: pnpm exec nx build frontend-agents

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3.0.0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2.1.2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2.1.0

      - name: Configure Docker
        run: gcloud auth configure-docker --quiet

      - name: Build and Push Docker Image
        run: |
          docker build -t gcr.io/${{ env.GCP_PROJECT_ID }}/frontend-agents:${{ github.sha }} \
            -t gcr.io/${{ env.GCP_PROJECT_ID }}/frontend-agents:latest \
            -f apps/frontend-agents/Dockerfile .
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/frontend-agents:${{ github.sha }}
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/frontend-agents:latest

      - name: Deploy to Google Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2.1.0
        with:
          service: frontend-agents
          image: gcr.io/${{ env.GCP_PROJECT_ID }}/frontend-agents:${{ github.sha }}
          region: ${{ env.GCP_REGION }}
          platform: managed

  deploy-agents:
    runs-on: ubuntu-latest
    env:
      STORE_PATH: ""
    needs: deploy-frontend # Assuming agents might depend on frontend or functions
    environment: production
    if: github.ref == 'refs/heads/main' # Only deploy to main branch
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10.0.0

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2.1.2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Build Agents
        run: pnpm exec nx build bq-agent looker-agent crm-agent content-agent reviews-agent gemini-orchestrator

      - name: Deploy Agents (Placeholder - Specific deployment will vary)
        run: |
          echo "Deploying agents... This step requires specific deployment logic for Vertex AI Agents or other agent hosting platforms."
          echo "Refer to GCP documentation for deploying Vertex AI Agents."
          # Example: gcloud ai-platform agents deploy ...

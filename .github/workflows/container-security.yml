name: Container Security Scanning

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/**'
      - 'Dockerfile*'
      - 'docker-compose*'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/**'
      - 'Dockerfile*'
      - 'docker-compose*'
  schedule:
    - cron: '0 6 * * 1' # Weekly on Monday at 6 AM UTC

permissions:
  contents: read
  security-events: write
  actions: read

env:
  REGISTRY: gcr.io
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

jobs:
  scan-containers:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app:
          - social-api
          - crm-api
          - cms-api
          - reviews-api
          - frontend-agents
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Build container image
        run: |
          if [ -f "apps/cloud-functions/${{ matrix.app }}/Dockerfile" ]; then
            docker build -t ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ matrix.app }}:${{ github.sha }} \
              -f apps/cloud-functions/${{ matrix.app }}/Dockerfile .
          elif [ -f "apps/${{ matrix.app }}/Dockerfile" ]; then
            docker build -t ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ matrix.app }}:${{ github.sha }} \
              -f apps/${{ matrix.app }}/Dockerfile .
          else
            echo "No Dockerfile found for ${{ matrix.app }}, creating minimal Node.js image"
            cat > Dockerfile.temp << EOF
          FROM node:20-alpine
          WORKDIR /app
          COPY package*.json ./
          RUN npm ci --only=production
          COPY apps/${{ matrix.app }} ./
          EXPOSE 8080
          CMD ["node", "index.js"]
          EOF
            docker build -t ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ matrix.app }}:${{ github.sha }} \
              -f Dockerfile.temp .
            rm Dockerfile.temp
          fi

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ matrix.app }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.app }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.app }}.sarif'
          category: 'container-${{ matrix.app }}'

      - name: Run Trivy for JSON output
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ matrix.app }}:${{ github.sha }}
          format: 'json'
          output: 'trivy-results-${{ matrix.app }}.json'

      - name: Check for critical vulnerabilities
        run: |
          CRITICAL_COUNT=$(jq '.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL") | length' trivy-results-${{ matrix.app }}.json | wc -l)
          HIGH_COUNT=$(jq '.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH") | length' trivy-results-${{ matrix.app }}.json | wc -l)
          
          echo "Critical vulnerabilities: $CRITICAL_COUNT"
          echo "High vulnerabilities: $HIGH_COUNT"
          
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "��� Critical vulnerabilities found in ${{ matrix.app }}"
            jq '.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")' trivy-results-${{ matrix.app }}.json
            exit 1
          fi
          
          if [ "$HIGH_COUNT" -gt 5 ]; then
            echo "⚠️ Too many high-severity vulnerabilities found in ${{ matrix.app }} ($HIGH_COUNT > 5)"
            exit 1
          fi
          
          echo "✅ Container security scan passed for ${{ matrix.app }}"

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-results-${{ matrix.app }}
          path: |
            trivy-results-${{ matrix.app }}.sarif
            trivy-results-${{ matrix.app }}.json
          retention-days: 30

  security-summary:
    runs-on: ubuntu-latest
    needs: scan-containers
    if: always()
    steps:
      - name: Download all scan results
        uses: actions/download-artifact@v4
        with:
          path: scan-results

      - name: Generate security summary
        run: |
          echo "# Container Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "**Scan Date:** $(date -u)" >> security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> security-summary.md
          echo "" >> security-summary.md
          
          for app in social-api crm-api cms-api reviews-api frontend-agents; do
            if [ -f "scan-results/trivy-results-$app/trivy-results-$app.json" ]; then
              echo "## $app" >> security-summary.md
              
              CRITICAL=$(jq '.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL") | length' "scan-results/trivy-results-$app/trivy-results-$app.json" | wc -l)
              HIGH=$(jq '.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH") | length' "scan-results/trivy-results-$app/trivy-results-$app.json" | wc -l)
              MEDIUM=$(jq '.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM") | length' "scan-results/trivy-results-$app/trivy-results-$app.json" | wc -l)
              
              echo "- **Critical:** $CRITICAL" >> security-summary.md
              echo "- **High:** $HIGH" >> security-summary.md
              echo "- **Medium:** $MEDIUM" >> security-summary.md
              echo "" >> security-summary.md
            fi
          done

      - name: Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 90
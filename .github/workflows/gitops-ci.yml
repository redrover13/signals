# GitHub Actions CI/CD Workflow for Dulce de Saigon
#
# This workflow orchestrates the entire CI/CD process, from code validation
# to deployment on Google Cloud Platform. It is designed to be secure,
# efficient, and compliant with Vietnamese data protection regulations.
#
# Key Features:
# - Secure Authentication: Uses Google Cloud's Workload Identity Federation (WIF)
#   to authenticate without service account keys.
# - Pull Request Trigger: The workflow runs automatically on every pull request
#   targeting the 'main' branch, ensuring all changes are validated.
# - Efficient Execution: Leverages Nx 'affected' commands to only run tests
#   and builds for the projects impacted by the changes.
# - Cloud Build Integration: Delegates the heavy lifting of building and deploying
#   to Google Cloud Build, which is optimized for the GCP environment.

name: 'GitOps CI/CD Pipeline'

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci-cd:
    name: 'Build, Test, and Deploy'
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: 'Authenticate to Google Cloud'
  uses: 'google-github-actions/auth@b7593ed2efd1c1617e1b0254da33b86225adb2a5' # latest stable SHA
        with:
          workload_identity_provider: '${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT }}'

      - name: 'Set up gcloud SDK'
        uses: 'google-github-actions/setup-gcloud@2b6391f633716b80d96d744b203c46a6f112e566' # v2.1.0

      - name: 'Set up Node.js and pnpm'
        uses: actions/setup-node@60edb5dd545a775199f52540f319c998c702a5f1 # v4.0.2
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 'Install Dependencies'
        run: pnpm install --frozen-lockfile

      - name: 'Run Linting'
        run: npx pnpm nx affected --target=lint --headless

      - name: 'Run Tests'
        run: npx pnpm nx affected --target=test --headless

      - name: 'Submit to Google Cloud Build'
        run: |
          gcloud builds submit --config cloudbuild.yaml . \
            --substitutions=_SHORT_SHA=${{ github.sha }}

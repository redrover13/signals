name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1

jobs:
  build-test-lint:
    runs-on: ubuntu-latest
    env:
      STORE_PATH: $(pnpm store path)
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup pnpm
        uses: pnpm/action-setup@8095b2b9580c96f4e9a8177bec82d79210851024 # v4.0.0
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@c4c9e84c7b9465a335b762113626741ec8e95c00 # v4.0.1
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --frozen-lockfile

      - name: Fix CodeQL and code standard issues
        run: pnpm codeql:fix

      - name: Run Lint
        run: pnpm nx lint

      - name: Run Tests
        run: pnpm nx test

      - name: Run Type Check
        run: pnpm nx affected --target=type-check --parallel

      - name: Run Static Analysis (SAST) on AI-Generated Code
        run: |
          # This is a placeholder. Replace with actual SAST tool commands.
          # Example using Semgrep (requires Semgrep CLI to be installed/available)
          # find . -type f -name "*.ts" -exec grep -l "// AI-GENERATED" {} + | xargs semgrep --config=auto

      - name: Setup pnpm cache
        uses: actions/cache@704facf57e6136b1bc63b828d79edcd491f0ee84 # v3.3.2
        with:
          path: |
            ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
          echo "Running SAST on AI-generated code sections..."
          # For demonstration, we'll just list files with AI-GENERATED tag
          grep -r "// AI-GENERATED" . || true

  terraform-plan:
    runs-on: ubuntu-latest
    env:
      STORE_PATH: $(pnpm store path)
    needs: build-test-lint
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Authenticate to GCP
        uses: google-github-actions/auth@55bd3a7c6e2ae7e6884bfe4c7bf685fe519a5a36 # v2.1.2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@1132c5212dd6f3331b4d72c86604f49a5d53b2e8 # v3.0.0
        with:
          terraform_version: 1.x

      - name: Terraform Init
        run: |
          cd infra/terraform/bigquery && terraform init
          cd ../functions && terraform init
          cd ../vertex-agents && terraform init
          cd ../looker && terraform init

      - name: Terraform Plan
        run: |
          cd infra/terraform/bigquery && terraform plan -out=tfplan_bigquery
          cd ../functions && terraform plan -out=tfplan_functions
          cd ../vertex-agents && terraform plan -out=tfplan_vertex_agents
          cd ../looker && terraform plan -out=tfplan_looker

      - name: Upload Terraform Plan Artifacts
        uses: actions/upload-artifact@0ad4c6ed3e171a3811d54af8513112f386372766 # v4.3.0
        with:
          name: terraform-plans
          path: |
            infra/terraform/bigquery/tfplan_bigquery
            infra/terraform/functions/tfplan_functions
            infra/terraform/vertex-agents/tfplan_vertex_agents
            infra/terraform/looker/tfplan_looker

  terraform-apply:
    runs-on: ubuntu-latest
    env:
      STORE_PATH: $(pnpm store path)
    needs: terraform-plan
    environment: production
    if: github.ref == 'refs/heads/main' # Only apply to main branch
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Authenticate to GCP
        uses: google-github-actions/auth@55bd3a7c6e2ae7e6884bfe4c7bf685fe519a5a36 # v2.1.2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@1132c5212dd6f3331b4d72c86604f49a5d53b2e8 # v3.0.0
        with:
          terraform_version: 1.x

      - name: Download Terraform Plan Artifacts
        uses: actions/download-artifact@v4
        with:
          name: terraform-plans
          path: .

      - name: Terraform Apply
        run: |
          cd infra/terraform/bigquery && terraform apply tfplan_bigquery
          cd ../functions && terraform apply tfplan_functions
          cd ../vertex-agents && terraform apply tfplan_vertex_agents
          cd ../looker && terraform apply tfplan_looker

  deploy-cloud-functions:
    runs-on: ubuntu-latest
    env:
      STORE_PATH: $(pnpm store path)
    needs: terraform-apply
    environment: production
    if: github.ref == 'refs/heads/main' # Only deploy to main branch
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup pnpm
        uses: pnpm/action-setup@8095b2b9580c96f4e9a8177bec82d79210851024 # v4.0.0
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@c4c9e84c7b9465a335b762113626741ec8e95c00 # v4.0.1
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --frozen-lockfile

      - name: Authenticate to GCP
        uses: google-github-actions/auth@55bd3a7c6e2ae7e6884bfe4c7bf685fe519a5a36 # v2.1.2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}

      - name: Setup pnpm cache
        uses: actions/cache@704facf57e6136b1bc63b828d79edcd491f0ee84 # v3.3.2
        with:
          path: |
            ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy Social API Function
        uses: google-github-actions/deploy-cloudfunctions@v2
        with:
          name: social-api
          runtime: nodejs20
          entry_point: main
          source_dir: apps/cloud-functions/social-api
          project_id: ${{ env.GCP_PROJECT_ID }}
          region: ${{ env.GCP_REGION }}

      - name: Deploy CRM API Function
        uses: google-github-actions/deploy-cloudfunctions@v2
        with:
          name: crm-api
          runtime: nodejs20
          entry_point: main
          source_dir: apps/cloud-functions/crm-api
          project_id: ${{ env.GCP_PROJECT_ID }}
          region: ${{ env.GCP_REGION }}

      - name: Deploy CMS API Function
        uses: google-github-actions/deploy-cloudfunctions@v2
        with:
          name: cms-api
          runtime: nodejs20
          entry_point: main
          source_dir: apps/cloud-functions/cms-api
          project_id: ${{ env.GCP_PROJECT_ID }}
          region: ${{ env.GCP_REGION }}

      - name: Deploy Reviews API Function
        uses: google-github-actions/deploy-cloudfunctions@v2
        with:
          name: reviews-api
          runtime: nodejs20
          entry_point: main
          source_dir: apps/cloud-functions/reviews-api
          project_id: ${{ env.GCP_PROJECT_ID }}
          region: ${{ env.GCP_REGION }}

  deploy-frontend:
    runs-on: ubuntu-latest
    env:
      STORE_PATH: $(pnpm store path)
    needs: deploy-cloud-functions
    environment: production
    if: github.ref == 'refs/heads/main' # Only deploy to main branch
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup pnpm
        uses: pnpm/action-setup@8095b2b9580c96f4e9a8177bec82d79210851024 # v4.0.0
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@c4c9e84c7b9465a335b762113626741ec8e95c00 # v4.0.1
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --frozen-lockfile

      - name: Build Frontend
        run: pnpm nx build frontend-agents

      - name: Deploy to Google Cloud Run (Example)
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: frontend-agents
          image: gcr.io/${{ env.GCP_PROJECT_ID }}/frontend-agents:${{ github.sha }}

      - name: Setup pnpm cache
        uses: actions/cache@704facf57e6136b1bc63b828d79edcd491f0ee84 # v3.3.2
        with:
          path: |
            ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
          region: ${{ env.GCP_REGION }}
          project_id: ${{ env.GCP_PROJECT_ID }}
          # Add other Cloud Run specific configurations as needed

  deploy-agents:
    runs-on: ubuntu-latest
    env:
      STORE_PATH: $(pnpm store path)
    needs: deploy-frontend # Assuming agents might depend on frontend or functions
    environment: production
    if: github.ref == 'refs/heads/main' # Only deploy to main branch
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup pnpm
        uses: pnpm/action-setup@8095b2b9580c96f4e9a8177bec82d79210851024 # v4.0.0
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@c4c9e84c7b9465a335b762113626741ec8e95c00 # v4.0.1
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --frozen-lockfile

      - name: Authenticate to GCP
        uses: google-github-actions/auth@55bd3a7c6e2ae7e6884bfe4c7bf685fe519a5a36 # v2.1.2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}

      - name: Setup pnpm cache
        uses: actions/cache@704facf57e6136b1bc63b828d79edcd491f0ee84 # v3.3.2
        with:
          path: |
            ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Build Agents
        run: pnpm nx build bq-agent looker-agent crm-agent content-agent reviews-agent gemini-orchestrator

      - name: Deploy Agents (Placeholder - Specific deployment will vary)
        run: |
          echo "Deploying agents... This step requires specific deployment logic for Vertex AI Agents or other agent hosting platforms."
          echo "Refer to GCP documentation for deploying Vertex AI Agents."
          # Example: gcloud ai-platform agents deploy ...
